---
title: "Evolutionary Rates & Selection Strength"
output: html_document
---

This vignette explains how to extract evolutionary rate parameters estimated from relaxed clock Bayesian inference analyses produced by the program Mr. Bayes. It also shows how to use evolutionary rate based inference of selection strength (or mode) adapted to clock-based rates, as introduced by [Sim√µes & Pierce 2021](https://www.nature.com/articles/s41559-021-01532-x). 

```{r, setup, echo=FALSE}
knitr::opts_chunk$set(warning = FALSE)
knitr::opts_knit$set(root.dir = "E:/Git/EvoPhylo/_dev/Examples/")
```

# Evolutionary Rates Statistics and Plots

Open the *EvoPhylo* package

```{r}
library(EvoPhylo)
library(ggtree)
library(ggplot2)
```

Extract evolutionary rate summary statistics from each node from a Bayesian clock (time-calibrate) summary tree produced by Mr. Bayes, store them in a data frame, produce summary tables, and plots:

1. First, get rates from tree file and create rate table. 
2. Export the rate table

```{r}
#Import summary tree produced by Mr. Bayes
tree<-treeio::read.mrbayes("Tree_3p(raw).t")

#Get table of clock rates with summary stats for each node in the tree for each relaxed clock partition 
RateTable_Medians_no_clades <- get_clockrate_table(tree, summary = "median")

#Export the rate table
#write.csv(RateTable_Medians_no_clades, file="RateTable_Medians.csv")
```

3. Import rate table with customized clade membership added as an extra column
4. Get summary statistics table and plots for each clade by clock 

```{r}
#Import rate table with clade membership 
RateTable_Medians<- read.csv("RateTable_Medians_Clades.csv", header = TRUE)

#Get summary statistics table for each clade by clock 
clockrate_summary(RateTable_Medians, "Sum_RateTable_Medians.csv", digits=2)
```

```{r, echo = FALSE}
clockrate_summary(RateTable_Medians, digits=2) 
```

Plot distributions of rates by clock partition and clade
```{r}
#Overlapping plots
clockrate_dens_plot(RateTable_Medians, stack = FALSE, nrow = 1, scales = "fixed")
```
```{r}
#Stacked plots
clockrate_dens_plot(RateTable_Medians, stack = TRUE, nrow = 1, scales = "fixed")
```

```{r}
#Stacked plots with viridis color scale
clockrate_dens_plot(RateTable_Medians, stack = TRUE, nrow = 1, scales = "fixed")+
    ggplot2::scale_color_viridis_d() +
    ggplot2::scale_fill_viridis_d()
```

Plot linear regressions of rates from two or more clocks

```{r}
#Plot regressions of rates from two clocks
p12 <- clockrate_reg_plot(RateTable_Medians, clock_x = 1, clock_y = 2)
p13 <- clockrate_reg_plot(RateTable_Medians, clock_x = 1, clock_y = 3)
p23 <- clockrate_reg_plot(RateTable_Medians, clock_x = 2, clock_y = 3)

gridExtra::grid.arrange(p12, p13, p23, nrow = 2)

```


# SelectionStrength

1. Import rate table with customized clade membership added as an extra column
2. Import combined log file from all runs. This is produced by using `import_log`, or using LogCombiner from the [BEAST2](https://www.beast2.org/beagle-beast-2-in-cluster/index.html) software package.

```{r}
#Import rate table with clade membership 
RateTable_Means<- read.csv("RateTable_Means_Clades.csv", header = TRUE)

#Transform table from wide to long format
RatesByClade <- clock_reshape(RateTable_Means)

#Import combined log file from all runs (if available)
Comb_posterior3p <- read.table("3p_CombLog(4runs)_8k.p", header = TRUE)

#OR

#Import all log (.p) files from all runs and combine them, with burn-in = 25% and downsampling to 10k trees in file
#Comb_posterior3p <- import_log("E:/Git/EvoPhylo/_dev/Examples/LogFiles3p", burnin = 0.25, downsample = 10000)
```

3. Produce a table of pairwise t-tests for difference between the mean clockrate value in the posterior and the absolute rate for each tree node
```{r}
#Get table of pairwise t-tests for difference between the posterior mean and the rate for each tree node
RateSign_tests<- get_pwt_rates(RateTable_Medians, Comb_posterior3p)

#Show first 10 lines of table
head(RateSign_tests, 10)

#Export the table
#write.csv(RateSign_tests, file="RateSign_tests.csv")
```

4. Plot selection gradient on the summary tree
```{r}
#Plot tree using various thresholds
plot_treerates_sgn(tree, Comb_posterior3p, 
                   clock = 1,               #Show rates for clock partition 1
                   summary = "mean",        #sets summary stats to get from summary tree nodes
                   branch_size = 1.5, tip_size = 2,                      #sets size for tree elements
                   xlim=c(-450,-250), nbreaks = 8, geo_size=list(3, 3),  #sets limits and breaks for geoscale
                   threshold = c("1 SD", "2 SD", "95%"))                 #sets threshold for selection mode

```
