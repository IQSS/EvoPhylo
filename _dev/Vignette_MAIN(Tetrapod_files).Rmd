---
title: "Vignette_MAIN(Tetrapod_files)"
output: html_document
---

```{r setup, eval = TRUE}
knitr::opts_chunk$set(warning = FALSE)
```

An R package to implement data pre-processing steps for analyses like those in [Sim√µes & Pierce 2021](https://www.nature.com/articles/s41559-021-01532-x). 

### Install package EvoPhylo

```{r}
#devtools::install_github("tiago-simoes/EvoPhylo")
#install.packages("EvoPhylo")
library(EvoPhylo)
```

#### Character Partitioning
(Documented)

Simple Workflow: Generate distance matrix, analyze clusters with PAM under chosen k value (from Si) and simple vizualization:
```{r}
setwd("Examples/CharPartitioning/")

#Load character data matrix and produce Gower distance matrix
Dmatrix <- get_gower_dist("DataMatrix.nex", numeric = FALSE)

#Plot number of cluster against silhouette width
sw <- get_sil_widths(Dmatrix, max.k = 10)
plot(sw, color = "red", size=1)
#Decide on number of clusters based on plot; here, k = 3 partitions

#Generate and vizualize clusters with PAM under chosen k value. 
clusters <- make_clusters(Dmatrix, k = 3, tsne = FALSE)
plot(clusters)
```

Complete Workflow: Generate distance matrix, analyze clusters with PAM under chosen k value (from Si). Also, produce a graphic clustering (tSNEs), coloring data points according to PAM clusters, to independently verify PAM clustering
```{r}
#User may also generate clusters with PAM and produce a graphic clustering (tSNEs)
clusters <- make_clusters(Dmatrix, k = 3, tsne = TRUE, tsne_dim = 3)
plot(clusters, nrow = 2)

#Write clusters to Nexus file
cluster_to_nexus(clusters, file = "Clusters_Nexus.txt")
```

#### SelectionStrength
(Documented)

Workflow:
```{r}
data("rate_table_means")
data("tree1p")
RatesByClade <- clock_reshape(RateTable_Means)
posterior <- read.table("_dev/Examples/SelectionStrength/3p_TipNodeMC_CombLog_8k.p", header = TRUE)

#Get matrix of t-tests for difference between the posterior mean and each rate
get_pwt_rates(RatesByClade, posterior$clockrate.all.)

#Plot tree using various thresholds
plot_treerates_sgn(tree, posterior$clockrate.all., clock = 1,
   threshold = c("1 SD", "2 SD", "95%"))

```

#### ST&P_Rates
(Documented)

Workflow:
```{r}
data("tree1p")

#Get table of clock rates with given summary stat
RateTable_Means_no_clades <- get_clockrate_table(tree, summary = "mean")

#Get summary statistic table for each clade by clock 
data("ratemeans") #has clade added
clockrate_summary(RateTable_Means)

#Plot distributions of rates by clock and clade
clockrate_dens_plot(RateTable_Means, stack = TRUE, nrow = 1)

#Plot regressions of rates from two clocks
p12 <- clockrate_reg_plot(RateTable_Means, clock_x = 1, clock_y = 2)
p13 <- clockrate_reg_plot(RateTable_Means, clock_x = 1, clock_y = 3)
p23 <- clockrate_reg_plot(RateTable_Means, clock_x = 2, clock_y = 3)

gridExtra::grid.arrange(p12, p13, p23, nrow = 2)

```

#### ST&P_FBD
(Documented)

Workflow:
```{r}
#Reshape Allruns data from wide to long
#import_log()
data("posterior1p")

#Summarize parameters by time bin and analysis
FBD_summary(posterior1p)

#Plot density of parameter by time bin
FBD_dens_plot(posterior1p, parameter = "net_speciation", type = "density")
FBD_dens_plot(posterior1p, parameter = "net_speciation", type = "violin")

#Tests for normality and homoscedasticity for each parameter across time bins
#and analyses
FBD_tests1(posterior1p)

#Visualize deviations from normality and similarity of variances
FBD_normality_plot(posterior1p)

#Test differences in location for each parameter between time bins 
FBD_tests2(posterior1p)

```
